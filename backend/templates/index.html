<!DOCTYPE html>
<html lang="he" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מערכת סריקה</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&display=swap" rel="stylesheet">
</head>

<body>
    <header>
        <div class="brand">
            <span>⚡ Inventory</span>
        </div>
        <div>
            <select id="warehouse-selector" class="form-control"
                style="width:auto; display:inline-block; margin-inline-end: 1rem; padding: 0.3rem;">
                <!-- Populated by JS -->
            </select>
            <span class="status-indicator" id="connection-status"></span>
        </div>
    </header>

    <div class="container">
        <!-- Navigation Tabs -->
        <div class="tabs-container">
            <button class="tab-btn active" onclick="switchTab('tab-inventory')">📦 ניהול מלאי</button>
            <button class="tab-btn" onclick="switchTab('tab-orders')">🚚 הזמנות</button>
            <button class="tab-btn" onclick="switchTab('tab-reports')">📊 דוחות ופעילות</button>
        </div>

        <!-- TAB 1: INVENTORY -->
        <div id="tab-inventory" class="tab-content active">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                    <h3>רשימת מוצרים</h3>
                    <div id="last-scan-status" class="status-box">מוכן לסריקה</div>
                </div>

                <!-- Add New Item Bar -->
                <div
                    style="display: flex; gap: 1rem; margin-bottom: 2rem; background: #202020; padding: 1.5rem; border-radius: 12px;">
                    <input type="text" id="plan-name" placeholder="שם מוצר חדש..." class="form-control"
                        style="flex: 2;">
                    <input type="number" id="plan-price" placeholder="מחיר" class="form-control" style="width: 120px;">
                    <input type="number" id="plan-pack" placeholder="יח' במארז" class="form-control"
                        style="width: 140px;" value="1" min="1">
                    <label for="plan-image" class="btn btn-outline"
                        style="cursor: pointer; display: flex; align-items: center; padding: 0.5rem 1rem;">
                        📷 <input type="file" id="plan-image" style="display: none;" accept="image/*">
                    </label>
                    <button class="btn" onclick="addProductClass()">+ הוסף</button>
                </div>

                <div style="overflow-x: auto;">
                    <table class="unified-table">
                        <thead>
                            <tr>
                                <th>תמונה</th>
                                <th>שם מוצר</th>
                                <th>מחיר</th>
                                <th>מארז</th>
                                <th>סה"כ יחידות</th>
                                <th style="font-size:0.8rem; color:#888;">W1</th>
                                <th style="font-size:0.8rem; color:#888;">W2</th>
                                <th style="font-size:0.8rem; color:#888;">W3</th>
                                <th>הוסף מלאי</th>
                                <th>כמות במלאי (מארזים)</th>
                            </tr>
                        </thead>
                        <tbody id="inventory-list">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- TAB 2: ORDERS -->
        <div id="tab-orders" class="tab-content">
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h3>היסטוריית הזמנות</h3>
                    <button class="btn" onclick="openOrderModal()">📦 צור הזמנה חדשה</button>
                </div>
                <div style="overflow-x: auto; margin-top: 1.5rem;">
                    <table class="unified-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>לקוח</th>
                                <th>תאריך</th>
                                <th>סטטוס</th>
                                <th>ליקוט</th>
                                <th>פעולות</th>
                            </tr>
                        </thead>
                        <tbody id="orders-list-body">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- TAB 3: REPORTS -->
        <div id="tab-reports" class="tab-content">
            <div class="analytics-grid">
                <!-- Row 1: Key Metrics -->
                <div class="stat-card">
                    <h4>סה"כ הזמנות</h4>
                    <div id="stat-orders" class="stat-value" style="color: var(--secondary-color);">0</div>
                </div>
                <div class="stat-card">
                    <h4>הכנסות (משוער)</h4>
                    <div id="stat-revenue" class="stat-value" style="color: #4caf50;">₪0</div>
                </div>
                <div class="stat-card">
                    <h4>שווי מלאי כולל</h4>
                    <div class="stat-value" style="color: #ff9800;">-</div>
                </div>
                <div class="stat-card">
                    <h4>התראות מלאי</h4>
                    <div class="stat-value" style="color: #f44336;">0</div>
                </div>

                <!-- Row 2: Charts -->
                <div class="chart-card">
                    <h3 style="margin-top:0;">המוצרים הנמכרים ביותר</h3>
                    <div id="chart-top-products" style="height: 300px;"></div>
                </div>
                <div class="chart-card">
                    <h3 style="margin-top:0;">פעילות סריקה אחרונה</h3>
                    <div id="chart-container" style="height: 300px;"></div>
                </div>

                <!-- Row 3: History & Tools -->
                <div class="recent-scans-card">
                    <h3 style="margin-top:0;">יומן סריקות אחרון</h3>
                    <div style="overflow-x: auto;">
                        <table class="unified-table">
                            <thead>
                                <tr>
                                    <th>זמן</th>
                                    <th>ברקוד</th>
                                    <th>מוצר</th>
                                    <th>שינוי</th>
                                    <th>סטטוס</th>
                                </tr>
                            </thead>
                            <tbody id="history-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>


        </div>

        <!-- MODALS (Hidden) -->
        <!-- Batch Add Modal -->
        <div id="batch-modal" class="modal">
            <div class="modal-content" style="width: 400px; text-align: center;">
                <h2 id="batch-product-name" style="margin-bottom:1rem;"></h2>
                <p>ברקוד: <span id="batch-barcode" style="color:var(--primary-color)"></span></p>
                <div style="margin: 2rem 0;">
                    <input type="number" id="batch-quantity" value="1" min="1" class="form-control"
                        style="font-size: 2.5rem; text-align: center; width: 140px; height: 80px; margin: 0 auto;">
                </div>
                <div style="display:flex; gap:10px; justify-content:center;">
                    <button class="btn btn-outline" onclick="closeBatchModal()">ביטול</button>
                    <button class="btn" onclick="confirmBatchAdd()">אישור</button>
                </div>
            </div>
        </div>

        <!-- Create Order Modal -->
        <div id="order-modal" class="modal">
            <div class="modal-content">
                <div style="display:flex; justify-content:space-between; margin-bottom:1.5rem;">
                    <h2>📦 צור הזמנה</h2>
                    <button class="btn-outline" style="border:none; font-size:1.5rem;"
                        onclick="closeOrderModal()">×</button>
                </div>
                <input type="text" id="order-business" class="form-control" placeholder="שם הלקוח"
                    style="margin-bottom:1rem;">
                <input type="text" id="order-search" class="form-control" placeholder="🔍 חפש מוצר..."
                    oninput="filterOrderList()" style="margin-bottom:1rem;">

                <div id="order-list-container"
                    style="flex:1; overflow-y:auto; border:1px solid #333; border-radius:8px; padding:10px; margin-bottom:1rem; min-height:300px;">
                </div>

                <div style="display:flex; justify-content:space-between; align-items:center; font-size:1.2rem;">
                    <span>סה"כ: <strong id="order-total-count" style="color:var(--secondary-color)">0</strong></span>
                    <button class="btn" onclick="submitOrder()" style="background: white; color: black;">🖨️ הדפס
                        ושמור</button>
                </div>
            </div>
        </div>

        <!-- Order Details Viewer -->
        <div id="order-details-modal" class="modal">
            <div class="modal-content">
                <div style="display:flex; justify-content:space-between; margin-bottom:1rem;">
                    <h2 id="order-details-title">פרטים</h2>
                    <button class="btn-outline" onclick="closeOrderDetailsModal()" style="border:none;">×</button>
                </div>
                <div style="max-height:500px; overflow-y:auto;">
                    <table class="unified-table">
                        <thead>
                            <tr>
                                <th>מוצר</th>
                                <th>כמות</th>
                                <th>לוקט</th>
                            </tr>
                        </thead>
                        <tbody id="order-details-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Instances Viewer -->
        <div id="instances-modal" class="modal">
            <div class="modal-content">
                <h2 id="instance-title">היסטוריית פריט</h2>
                <div style="max-height:400px; overflow-y:auto; margin-top:1rem;">
                    <table class="unified-table">
                        <thead>
                            <tr>
                                <th>זמן</th>
                                <th>ברקוד</th>
                            </tr>
                        </thead>
                        <tbody id="instances-list"></tbody>
                    </table>
                </div>
                <button class="btn btn-outline" onclick="closeInstancesModal()"
                    style="margin-top:1rem; width:100%;">סגור</button>
            </div>
        </div>

        <script src="{{ url_for('static', filename='js/script.js') }}"></script>
        <script>
            // Simple Tab Logic
            function switchTab(tabId) {
                document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
                document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));

                document.getElementById(tabId).classList.add('active');
                event.target.classList.add('active');
            }
        </script>
</body>

</html>